<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f2f2a" />
  <title>Cyber Seeds — Resources Hub</title>
  <meta name="description" content="Your personalised Cyber Seeds resources hub, built from your last household snapshot on this device." />
  <link rel="icon" href="/cyber_seeds_logo.png" />
  <link rel="canonical" href="https://cyberseeds.co.uk/resources/" />
  <link rel="stylesheet" href="/style.css?v=20260126" />

  <style>
    :root{
      --cs-ink:#1a6a5d;        /* Cyber Seeds primary green */
      --cs-ink-2:#0f4f45;
      --cs-muted:rgba(15,47,42,.72);
      --cs-muted-2:rgba(15,47,42,.58);
      --cs-soft:rgba(15,47,42,.06);
      --cs-soft-2:rgba(15,47,42,.10);
      --cs-border:rgba(15,47,42,.14);
      --cs-card:#ffffff;
      --cs-bg:#f6fbfa;
      --cs-shadow:0 10px 35px rgba(15,47,42,.10);
      --cs-radius:22px;
      --cs-radius-lg:28px;
      --cs-gap:16px;
      --cs-gap-lg:22px;
      --cs-max:1120px;

      --good: rgba(0,128,96,.12);
      --good-b: rgba(0,128,96,.25);
      --bad: rgba(180,70,70,.12);
      --bad-b: rgba(180,70,70,.25);
      .h2,
      .node-title,
      .step-title,
      .seed-title{
        color: #1a6a5d;
       }

    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--cs-ink);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(24,116,102,.11), transparent 55%),
        radial-gradient(900px 500px at 82% 12%, rgba(60,171,150,.10), transparent 50%),
        var(--cs-bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
    }

    main{
      width:min(var(--cs-max), 92vw);
      margin:0 auto;
      padding:22px 0 56px;
    }

    /* Hero */
    .hub-hero{
      margin-top:6px;
      padding:22px 18px 18px;
    }

    .eyebrow{
      font-size:.90rem;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:rgba(15,47,42,.60);
      font-weight:850;
      margin-bottom:8px;
    }

    .hub-title{
      font-size:clamp(2.05rem, 6vw, 3.2rem);
      line-height:1.03;
      letter-spacing:-0.03em;
      margin:6px 0 10px;
      color:var(--cs-ink);
    }

    .hub-subtitle{
      font-size:1.05rem;
      line-height:1.5;
      color:var(--cs-muted);
      max-width:62ch;
      margin:0 0 16px;
    }

    .hub-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:14px 18px;
      border-radius:999px;
      font-weight:800;
      text-decoration:none;
      border:2px solid var(--cs-ink);
      color:var(--cs-ink);
      background:transparent;
      transition:transform .12s ease, opacity .12s ease, background .12s ease;
      min-width:150px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      cursor:pointer;
    }

    .btn:active{ transform:scale(.985); opacity:.92; }
    .btn-primary{ background:var(--cs-ink); color:#fff; border-color:var(--cs-ink); }

    .pill-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    .pill{
      padding:10px 12px;
      border-radius:999px;
      background:var(--cs-soft);
      border:1px solid var(--cs-border);
      color:var(--cs-ink);
      font-weight:700;
      font-size:.95rem;
    }

    /* Grid */
    .grid{
      display:grid;
      gap:var(--cs-gap);
      margin-top:18px;
    }

    @media (min-width: 960px){
      .grid{
        grid-template-columns: 1.18fr .82fr;
        gap:var(--cs-gap-lg);
      }
    }

    .card{
      background:var(--cs-card);
      border-radius:var(--cs-radius-lg);
      border:1px solid var(--cs-border);
      box-shadow:var(--cs-shadow);
      overflow:hidden;
    }

    .card-pad{ padding:18px; }

    .h2{
      font-size:1.55rem;
      line-height:1.15;
      margin:0 0 10px;
      color:var(--cs-ink);
      letter-spacing:-.01em;
    }

    .p{
      margin:0;
      color:var(--cs-muted);
      line-height:1.55;
      font-size:1rem;
    }

    .divider{
      height:1px;
      background:var(--cs-soft-2);
      margin:16px 0;
    }

    /* Lens ring module */
    .ring-wrap{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      border:1px solid var(--cs-border);
      background:linear-gradient(180deg, rgba(15,47,42,.04), rgba(15,47,42,.02));
    }

    .ring-grid{
      display:grid;
      gap:12px;
      align-items:center;
    }

    @media (min-width: 480px){
      .ring-grid{
        grid-template-columns: 180px 1fr;
        gap:16px;
      }
    }

    .ring-svg{
      width:180px;
      height:180px;
      display:block;
      margin:0 auto;
    }

    .ring-center{
      font-weight:950;
      text-anchor:middle;
      dominant-baseline:middle;
      fill:var(--cs-ink);
    }

    .ring-stage{
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      fill:rgba(15,47,42,.62);
      font-weight:850;
    }

    .ring-score{
      font-size:20px;
      font-weight:950;
      letter-spacing:-.02em;
    }

    .ring-help{
      color:var(--cs-muted);
      font-size:.98rem;
      line-height:1.5;
    }

    .legend{
      display:grid;
      gap:8px;
      margin-top:10px;
    }

    .legend-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(15,47,42,.12);
      background:#fff;
    }

    .legend-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background:var(--cs-ink);
      opacity:.18;
      flex:none;
    }

    .legend-name{
      font-weight:900;
      letter-spacing:-.01em;
      color:var(--cs-ink);
      white-space:nowrap;
    }

    .legend-val{
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      background:var(--cs-soft);
      border:1px solid var(--cs-border);
      min-width:72px;
      text-align:center;
      flex:none;
    }

    .legend-row.is-focus{
      border-color: rgba(24,116,102,.35);
      box-shadow:0 0 0 3px rgba(24,116,102,.08) inset;
    }

    /* Household map */
    .map-wrap{
      margin-top:12px;
      padding:14px;
      background:linear-gradient(180deg, rgba(15,47,42,.04), rgba(15,47,42,.02));
      border:1px solid var(--cs-border);
      border-radius:18px;
    }

    .map{ display:grid; gap:10px; }

    .map-node{
      border-radius:16px;
      border:1px solid var(--cs-border);
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .node-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .node-title{
      font-weight:950;
      color:var(--cs-ink);
      letter-spacing:-.01em;
      font-size:1.05rem;
    }

    .node-tag{
      font-size:.85rem;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:var(--cs-soft);
      border:1px solid var(--cs-border);
      color:var(--cs-ink);
      white-space:nowrap;
    }

    .node-text{
      color:var(--cs-muted);
      line-height:1.35;
      font-size:.96rem;
    }

    .map-arrow{
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(15,47,42,.62);
      font-weight:850;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.82rem;
      justify-content:center;
      padding:4px 0;
      flex-wrap:wrap;
    }

    .map-arrow svg{ width:20px; height:20px; opacity:.8; }

    /* Actions */
    .list{ display:grid; gap:10px; margin-top:14px; }

    .step{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:12px;
      border-radius:18px;
      background:rgba(15,47,42,.035);
      border:1px solid rgba(15,47,42,.10);
    }

    .num{
      width:32px;
      height:32px;
      border-radius:12px;
      display:grid;
      place-items:center;
      background:#fff;
      border:1px solid var(--cs-border);
      font-weight:950;
      color:var(--cs-ink);
      flex:none;
    }

    .step-title{
      font-weight:950;
      color:var(--cs-ink);
      margin-bottom:3px;
      letter-spacing:-.01em;
    }

    .step-text{
      color:var(--cs-muted);
      line-height:1.4;
      font-size:.98rem;
    }

    .seedline{
      margin-top:12px;
      padding:14px;
      border-radius:18px;
      border:1px solid var(--cs-border);
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .seed-badge{
      flex:none;
      width:36px;
      height:36px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background:var(--cs-soft);
      border:1px solid var(--cs-border);
    }

    .seed-badge svg{ width:20px; height:20px; }

    .seed-title{
      font-weight:950;
      color:var(--cs-ink);
      margin:0 0 3px;
      letter-spacing:-.01em;
    }

    .seed-text{
      margin:0;
      color:var(--cs-muted);
      line-height:1.45;
      font-size:.98rem;
    }

    /* Overview / progress */
    .mini{
      font-size:.92rem;
      color:rgba(15,47,42,.62);
      line-height:1.45;
    }

    .status{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(15,47,42,.12);
      background:rgba(255,255,255,.85);
    }

    .status strong{ color:var(--cs-ink); }

    .progress-grid{
      display:grid;
      gap:10px;
      margin-top:12px;
    }

    .progress-row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(15,47,42,.12);
      background:#fff;
    }

    .progress-label{
      font-weight:950;
      color:var(--cs-ink);
      letter-spacing:-.01em;
    }

    .progress-delta{
      font-weight:950;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--cs-border);
      background:var(--cs-soft);
      color:var(--cs-ink);
      min-width:84px;
      text-align:center;
      white-space:nowrap;
    }

    .progress-delta.good{ background:var(--good); border-color:var(--good-b); }
    .progress-delta.bad{ background:var(--bad); border-color:var(--bad-b); }

    .muted-note{
      margin-top:10px;
      font-size:.92rem;
      color:rgba(15,47,42,.62);
      line-height:1.45;
    }

    .empty{
      padding:18px;
      border-radius:var(--cs-radius-lg);
      border:1px dashed rgba(15,47,42,.25);
      background:rgba(255,255,255,.7);
    }

    .empty h3{
      margin:0 0 8px;
      color:var(--cs-ink);
      letter-spacing:-.01em;
    }

    .empty p{
      margin:0 0 14px;
      color:var(--cs-muted);
      line-height:1.5;
    }

    footer{
      width:min(var(--cs-max), 92vw);
      margin:18px auto 40px;
      padding:10px 0 0;
      color:rgba(15,47,42,.60);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    footer a{
      color:rgba(15,47,42,.70);
      text-decoration:none;
      font-weight:800;
    }

    /* iPhone portrait tightening */
    @media (max-width: 420px){
      main{ width: 94vw; }
      .hub-hero{ padding:18px 14px 16px; }
      .hub-subtitle{ font-size:1.02rem; }
      .btn{ min-width: 145px; padding:13px 16px; }
      .card-pad{ padding:16px; }
      .ring-svg{ width:168px; height:168px; }
      .legend-val{ min-width:66px; }
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .btn{ transition:none; }
    }
  </style>
</head>

<body>
  <main id="main">
    <section class="hub-hero">
      <div class="eyebrow">Your personalised resources</div>
      <h1 class="hub-title">Your Resources Hub</h1>
      <p class="hub-subtitle">
        Built from your last household snapshot on <strong>this device</strong>.
        If you haven’t taken one yet, start here — you’ll get calm next steps within minutes.
      </p>

      <div class="hub-actions">
        <button class="btn btn-primary" type="button" data-open-snapshot>Take snapshot</button>
        <a class="btn" href="/" id="backHomeBtn">Back to home</a>
      </div>

      <div class="pill-row" aria-label="Trust signals">
        <span class="pill">Runs locally</span>
        <span class="pill">No accounts</span>
        <span class="pill">No tracking</span>
        <span class="pill">Clear next steps</span>
      </div>
    </section>

    <section class="grid" aria-label="Resources hub content">
      <!-- LEFT -->
      <div class="card">
        <div class="card-pad">
          <div class="eyebrow">Your prioritised focus</div>
          <h2 class="h2" id="focusTitle">Loading your focus…</h2>
          <p class="p" id="focusDesc">We’ll build your next steps from the last snapshot stored on this device.</p>

          <div class="divider"></div>

          <!-- Lens Ring -->
          <div class="eyebrow">Lens map</div>
          <h3 class="h2" style="margin-top:0;">Your five-lens safety ring</h3>
          <p class="p">This is your household’s digital ecology at a glance. One highlighted lens = your fastest improvement path.</p>

          <div class="ring-wrap" role="group" aria-label="Five lens ring">
            <div class="ring-grid">
              <svg class="ring-svg" viewBox="0 0 200 200" aria-label="Lens ring diagram">
                <!-- track -->
                <circle cx="100" cy="100" r="70" fill="none" stroke="rgba(15,47,42,.10)" stroke-width="18"></circle>

                <!-- 5 segments -->
                <g id="ringSegments" transform="rotate(-90 100 100)">
                  <path id="segNetwork" d="" stroke="#1a6a5d" stroke-width="18" fill="none" stroke-linecap="round" opacity="0.25"></path>
                  <path id="segDevices" d="" stroke="#1a6a5d" stroke-width="18" fill="none" stroke-linecap="round" opacity="0.25"></path>
                  <path id="segPrivacy" d="" stroke="#1a6a5d" stroke-width="18" fill="none" stroke-linecap="round" opacity="0.25"></path>
                  <path id="segScams" d="" stroke="#1a6a5d" stroke-width="18" fill="none" stroke-linecap="round" opacity="0.25"></path>
                  <path id="segWellbeing" d="" stroke="#1a6a5d" stroke-width="18" fill="none" stroke-linecap="round" opacity="0.25"></path>

                  <!-- focus glow -->
                  <path id="segFocusGlow" d="" stroke="rgba(26,106,93,.65)" stroke-width="22" fill="none" stroke-linecap="round" opacity="0"></path>
                </g>

                <!-- center -->
                <text x="100" y="92" class="ring-center ring-stage" id="ringStage">STAGE</text>
                <text x="100" y="116" class="ring-center ring-score" id="ringScore">—</text>
                <text x="100" y="138" class="ring-center ring-stage" id="ringHint">FIVE LENSES</text>
              </svg>

              <div class="ring-help">
                <div class="legend" id="legendBox">
                  <div class="legend-row" id="legendNetwork">
                    <div class="legend-left"><span class="dot"></span><span class="legend-name">Network</span></div>
                    <div class="legend-val" id="valNetwork">—</div>
                  </div>
                  <div class="legend-row" id="legendDevices">
                    <div class="legend-left"><span class="dot"></span><span class="legend-name">Devices</span></div>
                    <div class="legend-val" id="valDevices">—</div>
                  </div>
                  <div class="legend-row" id="legendPrivacy">
                    <div class="legend-left"><span class="dot"></span><span class="legend-name">Accounts & Privacy</span></div>
                    <div class="legend-val" id="valPrivacy">—</div>
                  </div>
                  <div class="legend-row" id="legendScams">
                    <div class="legend-left"><span class="dot"></span><span class="legend-name">Scams & Messages</span></div>
                    <div class="legend-val" id="valScams">—</div>
                  </div>
                  <div class="legend-row" id="legendWellbeing">
                    <div class="legend-left"><span class="dot"></span><span class="legend-name">Children & Wellbeing</span></div>
                    <div class="legend-val" id="valWellbeing">—</div>
                  </div>
                </div>

                <p class="muted-note" id="ringNote">
                  A darker segment means stronger protection in that lens. Your focus lens is highlighted.
                </p>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Household Map -->
          <div class="eyebrow">Household map</div>
          <h3 class="h2" style="margin-top:0;">What protects everything else</h3>
          <p class="p">
            This is the structure most families never see — but it shapes nearly every online incident.
          </p>

          <div class="map-wrap" role="group" aria-label="Household map diagram">
            <div class="map">
              <div class="map-node">
                <div class="node-top">
                  <div class="node-title">Root accounts</div>
                  <div class="node-tag" id="rootTag">Email • Apple • Google</div>
                </div>
                <div class="node-text">
                  These accounts can reset passwords and restore access to other services.
                </div>
              </div>

              <div class="map-arrow" aria-hidden="true">
                <span>reset access</span>
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 14l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>spreads fast</span>
              </div>

              <div class="map-node">
                <div class="node-top">
                  <div class="node-title">Everything else</div>
                  <div class="node-tag">Bank • School • Social • Shopping</div>
                </div>
                <div class="node-text">
                  If the root accounts are compromised, attackers can move through the household quickly.
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <h3 class="h2">Small actions you can do today</h3>
          <div class="list" id="actionList"></div>

          <div class="seedline" aria-label="Digital Seed takeaway">
            <div class="seed-badge" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 21c4-3 7-7 7-12C16 9 12 4 12 4S8 9 5 9c0 5 3 9 7 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <p class="seed-title">Digital Seed</p>
              <p class="seed-text" id="seedText">Protect the “root accounts” (email + Apple/Google) before everything else.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside>
        <div class="card">
          <div class="card-pad">
            <div class="eyebrow">Your snapshot overview</div>
            <h2 class="h2" id="stageTitle">Loading your stage…</h2>
            <p class="p" id="stageDesc">This is a calm readout — not judgement. It’s a signal you can act on.</p>

            <div class="status" role="note" aria-label="Snapshot note">
              <div class="mini" id="fingerprintLine">
                <strong>Household fingerprint:</strong> building your pattern from the last snapshot…
              </div>
              <div class="muted-note" id="lastTakenLine"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card-pad">
            <div class="eyebrow">Progress tracking</div>
            <h2 class="h2">Retest and compare</h2>
            <p class="p">
              Cyber Seeds is designed for repeat snapshots. Small changes compound fast — and your progress should be visible.
            </p>

            <div class="progress-grid" id="progressGrid"></div>

            <p class="muted-note" id="progressNote">
              Tip: take a snapshot today, then retest in 2–6 weeks. This device remembers your baseline locally.
            </p>

            <div class="hub-actions" style="margin-top:14px;">
              <button class="btn btn-primary" id="saveBaselineBtn" type="button">Save as baseline</button>
              <button class="btn" id="clearBaselineBtn" type="button">Clear baseline</button>
            </div>
          </div>
        </div>

        <div class="card" id="emptyStateCard" style="display:none; margin-top:14px;">
          <div class="card-pad">
            <div class="empty">
              <h3>No snapshot found on this device</h3>
              <p>That’s completely okay. Take a quick snapshot and this page will build your personalised hub automatically.</p>
              <a class="btn btn-primary" href="/#snapshot">Take snapshot now</a>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <footer>
    <div>© <span id="year"></span> Cyber Seeds</div>
    <a href="/">Home</a>
  </footer>

  <script>
    (function(){
      "use strict";

      const $ = (sel, root=document) => root.querySelector(sel);

      // Year
      const YEAR = $("#year");
      if (YEAR) YEAR.textContent = String(new Date().getFullYear());

      // -------- Keys (future-proof) --------
      const SNAPSHOT_KEYS = [
        "seed_snapshot_v2",
        "cyberseeds_snapshot_last",
        "cyberSeeds_snapshot_last",
        "cs_snapshot_last",
        "snapshot_last",
        "cyberseeds_snapshot",
        "cyberSeedsSnapshot",
        "cyberSeeds.snapshot",
        "cs.snapshot.last",
        "cs:lastSnapshot"
      ];

      const BASELINE_KEY = "cyberseeds_snapshot_baseline_v2";

      function safeJSONParse(str){
        try { return JSON.parse(str); } catch { return null; }
      }

      function safeGetStorageItem(k){
        // iOS Safari can behave weirdly when storage is blocked
        try { return localStorage.getItem(k); } catch {}
        try { return sessionStorage.getItem(k); } catch {}
        return null;
      }

      function safeSetStorageItem(k, v){
        try { localStorage.setItem(k, v); return true; } catch {}
        try { sessionStorage.setItem(k, v); return true; } catch {}
        return false;
      }

      function safeRemoveStorageItem(k){
        try { localStorage.removeItem(k); } catch {}
        try { sessionStorage.removeItem(k); } catch {}
      }

      function getLastSnapshot(){
        for (const k of SNAPSHOT_KEYS){
          const raw = safeGetStorageItem(k);
          if (!raw) continue;
          const parsed = safeJSONParse(raw);
          if (parsed && typeof parsed === "object") return parsed;
        }
        return null;
      }

      // ----- Normalisation helpers -----
      function normScore(v){
        if (typeof v === "number") return `${v}/4`;
        if (typeof v === "string"){
          const m = v.match(/(\d)\s*\/\s*(\d)/);
          if (m) return `${m[1]}/${m[2]}`;
          const n = Number(v);
          if (!Number.isNaN(n) && n >= 0 && n <= 10) return `${n}/4`;
        }
        if (v && typeof v === "object"){
          if (typeof v.score === "number") return `${v.score}/4`;
          if (typeof v.value === "number") return `${v.value}/4`;
          if (typeof v.points === "number") return `${v.points}/4`;
        }
        return "—";
      }

      function toNumScore(val){
        if (typeof val === "number") return val;
        if (typeof val === "string"){
          const m = val.match(/(\d)\s*\/\s*(\d)/);
          if (m) return parseInt(m[1], 10);
          const n = Number(val);
          if (!Number.isNaN(n)) return n;
        }
        if (val && typeof val === "object"){
          if (typeof val.score === "number") return val.score;
          if (typeof val.value === "number") return val.value;
          if (typeof val.points === "number") return val.points;
        }
        return null;
      }

      function formatDate(ts){
        if (!ts) return "";
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return "";
        return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

        function extractLensScores(snap){
          // ✅ V2 primary
          if (snap.lensScores && typeof snap.lensScores === "object"){
            return {
              network:   snap.lensScores.network,
              devices:   snap.lensScores.devices,
              privacy:   snap.lensScores.privacy,
              scams:     snap.lensScores.scams,
              wellbeing: snap.lensScores.wellbeing
            };
          }

            // fallback legacy shapes
            const lens = snap.lenses || snap.scores || snap.subscores || {};
          
            return {
              network:   normScore(lens.network   ?? snap.networkScore),
              devices:   normScore(lens.devices   ?? snap.devicesScore),
              privacy:   normScore(lens.privacy   ?? snap.privacyScore),
              scams:     normScore(lens.scams     ?? snap.scamsScore),
              wellbeing: normScore(lens.wellbeing ?? snap.wellbeingScore)
            };
          }


      // ✅ Bulletproof stage normaliser (fixes [object Object] forever)
      function extractStage(snap){
        const fallbackDesc =
          "A few risk flows need tightening. Small changes will reduce stress and risk quickly.";

        const raw =
          snap.stage ??
          snap.stage_label ??
          snap.stageLabel ??
          snap.band ??
          snap.tier ??
          snap.level ??
          "Emerging";

        // stage object from snapshot engine: { name, desc }
        if (raw && typeof raw === "object"){
          const label =
            raw.name ?? raw.stage ?? raw.label ?? raw.tier ?? raw.level ?? "Emerging";

          const desc =
            raw.desc ??
            raw.description ??
            raw.text ??
            snap.stage_desc ??
            snap.stageDescription ??
            snap.summary ??
            fallbackDesc;

          return { stage: String(label), desc: String(desc) };
        }

        const label = String(raw || "Emerging");
        const desc = String(
          snap.stage_desc ||
          snap.stageDescription ||
          snap.summary ||
          fallbackDesc
        );

        return { stage: label, desc };
      }

      function weakestLens(scores){
        const entries = Object.entries(scores)
          .map(([k,v]) => [k, toNumScore(v)])
          .filter(([,n]) => typeof n === "number");

        if (!entries.length) return "privacy";
        entries.sort((a,b) => a[1]-b[1]);
        return entries[0][0];
      }

      function focusCopyForLens(lensKey){
        const map = {
          privacy: { title:"Privacy Lens — protect accounts that protect everything else", desc:"If email or Apple/Google accounts are compromised, attackers can reset passwords elsewhere." },
          network: { title:"Network Lens — strengthen the boundary of your home", desc:"Your Wi-Fi is the front door. Small changes here protect every device inside." },
          devices: { title:"Device Lens — keep the household healthy and updated", desc:"Out-of-date devices become weak links. Quick hygiene steps reduce risk and chaos." },
          scams: { title:"Scam Lens — reduce the moments that scams win", desc:"Scams succeed when people are rushed, emotional, or unsure. Guardrails stop damage early." },
          wellbeing:{ title:"Wellbeing Lens — calm routines reduce digital harm", desc:"Healthier rhythms and boundaries reduce exposure, conflict, and impulsive risks." }
        };
        return map[lensKey] || map.privacy;
      }

      function actionsForLens(lensKey){
        const actions = {
          privacy: [
            {
              t:"Harden your root email account",
              d:"Your email can reset passwords for most services. If it falls, everything connected can follow. Enable 2-step verification and review recovery options."
            },
            {
              t:"Protect Apple / Google identity",
              d:"These accounts often unlock devices, backups, and app stores. Add 2SV and remove any old recovery numbers or emails."
            },
            {
              t:"Eliminate password reuse at the top",
              d:"Start with your top 5 accounts. Unique passwords here dramatically reduce cascade risk across the household."
            },
            {
              t:"Reduce public personal data",
              d:"Remove address, school, birthday, and routine details from public profiles where possible. Less exposure = less targeting."
            }
          ],
      
          network: [
            {
              t:"Secure router admin access",
              d:"Router control is household control. Change the admin password and store it safely."
            },
            {
              t:"Upgrade Wi-Fi protection mode",
              d:"Use WPA2 or WPA3 with a long passphrase. This protects every device using your network."
            },
            {
              t:"Disable WPS quick-connect",
              d:"WPS is convenient but easier to abuse. Turning it off tightens your perimeter."
            },
            {
              t:"Separate guests and smart devices",
              d:"A guest network reduces cross-device exposure and keeps family devices safer."
            }
          ],
      
          devices: [
            {
              t:"Turn on automatic updates everywhere",
              d:"Updates close known security holes. Automation removes the need to remember."
            },
            {
              t:"Remove unused apps and accounts",
              d:"Every unused app is an unnecessary doorway. Clean devices are safer devices."
            },
            {
              t:"Add device lock screens",
              d:"PIN, fingerprint, or FaceID prevents casual access turning into account takeover."
            },
            {
              t:"Back up irreplaceable data",
              d:"Photos and documents deserve a recovery path. Backups reduce panic and loss."
            }
          ],
      
          scams: [
            {
              t:"Adopt the household pause rule",
              d:"Urgent + emotional messages are a scam pattern. Pause, verify, then act."
            },
            {
              t:"Verify through official channels",
              d:"Never trust links in messages for banks or delivery firms. Use official apps or saved bookmarks."
            },
            {
              t:"Enable transaction alerts",
              d:"Fast alerts shrink damage windows and increase recovery success."
            },
            {
              t:"Create family safe phrases",
              d:"Short phrases like “I’ll check the official app” build shared defence habits."
            }
          ],
      
          wellbeing: [
            {
              t:"Set a calm device cut-off time",
              d:"A small nightly boundary improves sleep and reduces late-night risk decisions."
            },
            {
              t:"Reduce notification overload",
              d:"Fewer alerts = more control. Keep only what truly matters."
            },
            {
              t:"Create a shared charging place",
              d:"Central charging reduces overnight scrolling and household tension."
            },
            {
              t:"Use screen tools as support",
              d:"Use limits as guidance, not punishment. Consistency beats strictness."
            }
          ]
        };
      
        return actions[lensKey] || actions.privacy;
      }

      function renderActions(lensKey){
        const list = $("#actionList");
        if (!list) return;
        list.innerHTML = "";
        const items = actionsForLens(lensKey);
        items.forEach((it, idx) => {
          const row = document.createElement("div");
          row.className = "step";
          row.innerHTML = `
            <div class="num">${idx+1}</div>
            <div>
              <div class="step-title"></div>
              <div class="step-text"></div>
            </div>
          `;
          row.querySelector(".step-title").textContent = it.t;
          row.querySelector(".step-text").textContent = it.d;
          list.appendChild(row);
        });
      }

      function setText(id, text){
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      function setHTML(id, html){
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      }

      function show(el, yes){
        if (!el) return;
        el.style.display = yes ? "" : "none";
      }

      // -------- Fingerprint (calm + explainable) --------
      function buildFingerprint(scores){
        const vals = {
          network: toNumScore(scores.network),
          devices: toNumScore(scores.devices),
          privacy: toNumScore(scores.privacy),
          scams: toNumScore(scores.scams),
          wellbeing: toNumScore(scores.wellbeing),
        };

        let pattern = "Emerging Resilience";
        let note = "Your system is functional — focus on one lens and you’ll feel the difference fast.";

        const lows = Object.entries(vals).filter(([,v]) => typeof v === "number" && v <= 2).map(([k]) => k);

        if (lows.includes("privacy")){
          pattern = "Root Account Cascade Risk";
          note = "Email + Apple/Google sit at the centre. Strengthen them first to protect everything else.";
        } else if (lows.includes("network")){
          pattern = "Perimeter Drift";
          note = "The Wi-Fi boundary needs tightening so the household has a stronger edge.";
        } else if (lows.includes("devices")){
          pattern = "Device Hygiene Drag";
          note = "A few update + cleanup habits reduce risk and stress quickly.";
        } else if (lows.includes("scams")){
          pattern = "Pressure-Point Scam Risk";
          note = "One calm rule can prevent impulsive clicks turning into money or account loss.";
        } else if (lows.includes("wellbeing")){
          pattern = "Attention + Sleep Loop";
          note = "Stabilising routines reduces exposure, conflict, and risk moments.";
        }

        return { pattern, note };
      }

      // -------- Progress baseline --------
      function getBaseline(){
        const raw = safeGetStorageItem(BASELINE_KEY);
        return raw ? safeJSONParse(raw) : null;
      }

      function setBaseline(snap){
        safeSetStorageItem(BASELINE_KEY, JSON.stringify({
          ts: Date.now(),
          scores: extractLensScores(snap),
          stage: extractStage(snap),
        }));
      }

      function clearBaseline(){
        safeRemoveStorageItem(BASELINE_KEY);
      }

      function renderProgress(currentScores){
        const grid = $("#progressGrid");
        if (!grid) return;
        grid.innerHTML = "";

        const baseline = getBaseline();
        if (!baseline || !baseline.scores){
          const el = document.createElement("div");
          el.className = "progress-row";
          el.innerHTML = `
            <div>
              <div class="progress-label">No baseline saved yet</div>
              <div class="mini">Tap <strong>Save as baseline</strong> to lock your starting point on this device.</div>
            </div>
            <div class="progress-delta">—</div>
          `;
          grid.appendChild(el);
          return;
        }

        const lensNames = [
          ["network","Network"],
          ["devices","Devices"],
          ["privacy","Privacy"],
          ["scams","Scams"],
          ["wellbeing","Wellbeing"],
        ];

        lensNames.forEach(([key, label]) => {
          const cur = toNumScore(currentScores[key]);
          const base = toNumScore(baseline.scores[key]);

          let delta = null;
          if (typeof cur === "number" && typeof base === "number"){
            delta = cur - base;
          }

          const row = document.createElement("div");
          row.className = "progress-row";

          let badge = "—";
          let cls = "progress-delta";
          if (delta !== null){
            if (delta > 0){ badge = `+${delta}`; cls += " good"; }
            else if (delta < 0){ badge = `${delta}`; cls += " bad"; }
            else { badge = "0"; }
          }

          row.innerHTML = `
            <div>
              <div class="progress-label">${label}</div>
              <div class="mini">Baseline ${baseline.scores[key]} → Now ${currentScores[key]}</div>
            </div>
            <div class="${cls}">${badge}</div>
          `;
          grid.appendChild(row);
        });

        const note = $("#progressNote");
        if (note){
          const when = formatDate(baseline.ts);
          note.textContent = when
            ? `Baseline saved locally on this device: ${when}. Retest whenever you like — progress should be visible.`
            : `Baseline saved locally on this device. Retest whenever you like — progress should be visible.`;
        }
      }

      // -------- SVG ring helpers --------
      function polarToCartesian(cx, cy, r, angleDeg){
        const rad = (angleDeg * Math.PI) / 180;
        return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
      }

      function arcPath(cx, cy, r, startAngle, endAngle){
        const start = polarToCartesian(cx, cy, r, endAngle);
        const end = polarToCartesian(cx, cy, r, startAngle);
        const largeArc = (endAngle - startAngle) <= 180 ? "0" : "1";
        return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArc} 0 ${end.x} ${end.y}`;
      }

      function opacityForScore(n){
        if (typeof n !== "number") return 0.18;
        const t = Math.max(0, Math.min(4, n)) / 4;
        return 0.18 + (0.77 * t);
      }

      function setSeg(id, d, op){
        const el = document.getElementById(id);
        if (!el) return;
        el.setAttribute("d", d);
        if (typeof op === "number") el.setAttribute("opacity", String(op));
      }

      function highlightLegend(focusKey){
        const ids = {
          network:"legendNetwork",
          devices:"legendDevices",
          privacy:"legendPrivacy",
          scams:"legendScams",
          wellbeing:"legendWellbeing"
        };
        Object.values(ids).forEach(x => {
          const el = document.getElementById(x);
          if (el) el.classList.remove("is-focus");
        });
        const active = document.getElementById(ids[focusKey]);
        if (active) active.classList.add("is-focus");
      }

      function renderRing(scores, stageLabel, focusKey){
        const start = 0;
        const step = 72;

        const order = [
          ["network","segNetwork"],
          ["devices","segDevices"],
          ["privacy","segPrivacy"],
          ["scams","segScams"],
          ["wellbeing","segWellbeing"]
        ];

        order.forEach(([key, segId], idx) => {
          const a0 = start + (idx * step);
          const a1 = a0 + step - 6; // gap
          const path = arcPath(100, 100, 70, a0, a1);
          const n = toNumScore(scores[key]);
          setSeg(segId, path, opacityForScore(n));
        });

        const focusIdx = order.findIndex(([k]) => k === focusKey);
        const glow = document.getElementById("segFocusGlow");

        if (glow && focusIdx >= 0){
          const a0 = start + (focusIdx * step);
          const a1 = a0 + step - 6;
          glow.setAttribute("d", arcPath(100,100,70, a0, a1));
          glow.setAttribute("opacity", "0.9");
        } else if (glow){
          glow.setAttribute("opacity", "0");
        }

        setText("ringStage", (stageLabel || "Emerging").toString().toUpperCase());

        const nums = ["network","devices","privacy","scams","wellbeing"]
          .map(k => toNumScore(scores[k]))
          .filter(n => typeof n === "number");

        const total = nums.length ? nums.reduce((a,b)=>a+b,0) : null;
        setText("ringScore", total !== null ? `${total}/20` : "—");
        setText("ringHint", "FIVE LENSES");
      }

      // -------- Main render --------
      const snapshot = getLastSnapshot();

      // Empty state
      if (!snapshot){
        show($("#emptyStateCard"), true);
        setText("focusTitle", "Take a snapshot to build your hub");
        setText("focusDesc", "Cyber Seeds will generate your prioritised focus, map, and next steps from your answers.");
        setText("stageTitle", "No snapshot yet");
        setText("stageDesc", "This page becomes personalised once a snapshot exists on this device.");

        const emptyScores = {network:"—",devices:"—",privacy:"—",scams:"—",wellbeing:"—"};
        setText("valNetwork","—"); setText("valDevices","—"); setText("valPrivacy","—"); setText("valScams","—"); setText("valWellbeing","—");

        renderRing(emptyScores, "Stage", "privacy");
        highlightLegend("privacy");
        renderActions("privacy");
        renderProgress(emptyScores);
        return;
      }

      // Snapshot exists
      show($("#emptyStateCard"), false);

      const scores = extractLensScores(snapshot);
      const stage = extractStage(snapshot);

      // Legend values
      setText("valNetwork", scores.network);
      setText("valDevices", scores.devices);
      setText("valPrivacy", scores.privacy);
      setText("valScams", scores.scams);
      setText("valWellbeing", scores.wellbeing);

      // Stage block
      setText("stageTitle", `${stage.stage} —`);
      setText("stageDesc", stage.desc);

      // Weakest lens = focus
      const wl = weakestLens(scores);
      const focus = focusCopyForLens(wl);

      setText("focusTitle", focus.title);
      setText("focusDesc", focus.desc);

      highlightLegend(wl);
      renderRing(scores, stage.stage, wl);

      // Actions
      renderActions(wl);

      // Seed line adapts
      const seedLine = {
        privacy: "Root accounts act like master keys. Strengthen them first and the rest of your digital household becomes easier to protect.",
        network: "Your Wi-Fi boundary is your digital front door. Small changes here protect every connected device.",
        devices: "Healthy, updated devices reduce both risk and stress across the household.",
        scams: "One calm verification habit prevents most scam damage before it starts.",
        wellbeing: "Stable routines quietly reduce exposure, conflict, and impulsive online risk."
      };

      setText("seedText", seedLine[wl] || seedLine.privacy);

      // Fingerprint
      const fp = buildFingerprint(scores);
      setHTML("fingerprintLine", `<strong>Household fingerprint:</strong> ${fp.pattern} — ${fp.note}`);

      // Last taken line (multi-field + compatibility)
      const ts =
        snapshot.ts ||
        snapshot.timestamp ||
        snapshot.createdAt ||
        snapshot.created_at ||
        (safeGetStorageItem("seed_snapshot_v2_ts") ? Number(safeGetStorageItem("seed_snapshot_v2_ts")) : null);

      const when = formatDate(ts);
      setText("lastTakenLine", when ? `Last snapshot on this device: ${when}` : `Last snapshot found on this device.`);

      // Progress
      renderProgress(scores);

      // Baseline buttons
      const saveBtn = $("#saveBaselineBtn");
      const clearBtn = $("#clearBaselineBtn");

      if (saveBtn){
        saveBtn.addEventListener("click", () => {
          setBaseline(snapshot);
          renderProgress(scores);
          saveBtn.textContent = "Baseline saved";
          setTimeout(() => (saveBtn.textContent = "Save as baseline"), 1100);
        });
      }

      if (clearBtn){
        clearBtn.addEventListener("click", () => {
          clearBaseline();
          renderProgress(scores);
          clearBtn.textContent = "Cleared";
          setTimeout(() => (clearBtn.textContent = "Clear baseline"), 1100);
        });
      }

      // ✅ Nice-to-have: refresh hub when a new snapshot is taken in another tab
      window.addEventListener("storage", (e) => {
        if (!e || !e.key) return;
        if (SNAPSHOT_KEYS.includes(e.key) || e.key === "seed_snapshot_v2_ts") {
          // hard refresh to rebuild everything safely
          location.reload();
        }
      });

    })();
  </script>

  <!-- Your global site script (modal etc) -->
  <script src="/script.js?v=20260131"></script>
</body>
</html>
